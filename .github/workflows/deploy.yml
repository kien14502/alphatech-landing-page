name: Deploy to Server

on:
 push:
  branches: ['main']

jobs:
 deploy:
  runs-on: ubuntu-latest
  environment: production

  steps:
   - name: Checkout repository
     uses: actions/checkout@v3

   - name: Setup SSH agent
     uses: webfactory/ssh-agent@v0.5.4
     with:
      ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

   - name: Copy files to server
     run: |
      rsync -avz --delete \
        -e "ssh -o StrictHostKeyChecking=no" \
        --exclude 'node_modules' \
        --exclude '.git' \
        ./ \
        ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.PROJECT_PATH }}

   - name: Deploy with Docker on server
     run: |
      ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
        cd ${{ secrets.PROJECT_PATH }}
        
        echo "ðŸ³ Building Docker image..."
        docker build -t my-app:latest .
        
        echo "ðŸ” Stopping existing container..."
        docker stop my-app-container || true
        docker rm my-app-container || true
        
        echo "ðŸš€ Starting new container..."
        docker run -d \
          --name my-app-container \
          --restart unless-stopped \
          -p 3000:3000 \
          my-app:latest
        
        echo "ðŸ§¹ Cleaning up unused images..."
        docker image prune -f
        
        echo "ðŸŽ‰ Deploy completed!"
      EOF
