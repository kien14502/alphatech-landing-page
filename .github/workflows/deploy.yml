name: Deploy to Server

on:
 push:
  branches: ['main']

jobs:
 deploy:
  runs-on: ubuntu-latest
  environment: production

  steps:
   - name: Checkout repository
     uses: actions/checkout@v3

   - name: Setup SSH agent
     uses: webfactory/ssh-agent@v0.5.4
     with:
      ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

   - name: Copy files to server
     run: |
      rsync -avz --delete \
        -e "ssh -o StrictHostKeyChecking=no" \
        ./ \
        ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.PROJECT_PATH }}

   - name: Run commands on server
     run: |
      ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
        cd ${{ secrets.PROJECT_PATH }}
        
        echo "ðŸ“¦ Pulling latest build..."
        pnpm install --frozen-lockfile
        
        echo "âš™ï¸ Building project..."
        pnpm build
        
        echo "ðŸ” Restarting PM2..."
        pm2 stop all || true
        pm2 start ecosystem.config.cjs
        
        echo "ðŸŽ‰ Deploy completed!"
      EOF
